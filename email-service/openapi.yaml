openapi: 3.0.3
info:
  title: Email/Notifications Service API
  description: |
    Microservicio de notificaciones y envío de emails para arquitectura de microservicios.
    
    Este servicio maneja:
    - Mensajes de contacto desde formularios
    - Notificaciones desde otros microservicios
    - Envío asíncrono de emails con Celery
    - Idempotencia y reintentos
  version: 1.0.0
  contact:
    name: Microservices Lab
    url: https://github.com/Hernandz09/microservices-lab

servers:
  - url: http://localhost:8002
    description: Development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Contact
    description: Contact form messages
  - name: Notifications
    description: Internal notifications from other services

paths:
  /healthz:
    get:
      tags:
        - Health
      summary: Health check
      description: Verifica el estado del servicio (DB + Redis)
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  checks:
                    type: object
                    properties:
                      database:
                        type: string
                        example: ok
                      redis:
                        type: string
                        example: ok
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: unhealthy
                  checks:
                    type: object

  /api/contact/:
    get:
      tags:
        - Contact
      summary: List contact messages
      description: Lista todos los mensajes de contacto con paginación
      parameters:
        - in: query
          name: page
          schema:
            type: integer
          description: Número de página
      responses:
        '200':
          description: Lista de mensajes de contacto
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  next:
                    type: string
                    nullable: true
                  previous:
                    type: string
                    nullable: true
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/ContactMessageList'

    post:
      tags:
        - Contact
      summary: Create contact message
      description: Crea un nuevo mensaje de contacto y lo encola para envío
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ContactMessageCreate'
            example:
              name: "Carlos Rivas"
              email: "carlos@mail.com"
              message: "Me interesa una colaboración en el proyecto"
      responses:
        '201':
          description: Mensaje creado y encolado
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: queued
                  message:
                    type: string
                    example: Mensaje recibido y encolado para envío
        '400':
          description: Datos inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'

  /api/contact/{id}/:
    get:
      tags:
        - Contact
      summary: Get contact message detail
      description: Obtiene el detalle de un mensaje de contacto
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Detalle del mensaje
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ContactMessage'
        '404':
          description: Mensaje no encontrado

  /api/contact/stats/:
    get:
      tags:
        - Contact
      summary: Contact messages statistics
      description: Estadísticas de mensajes de contacto
      responses:
        '200':
          description: Estadísticas
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  pending:
                    type: integer
                  queued:
                    type: integer
                  sent:
                    type: integer
                  failed:
                    type: integer
              example:
                total: 150
                pending: 5
                queued: 10
                sent: 130
                failed: 5

  /api/notify/:
    get:
      tags:
        - Notifications
      summary: List notifications
      description: Lista todas las notificaciones enviadas
      parameters:
        - in: query
          name: page
          schema:
            type: integer
      responses:
        '200':
          description: Lista de notificaciones
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  next:
                    type: string
                    nullable: true
                  previous:
                    type: string
                    nullable: true
                  results:
                    type: array
                    items:
                      $ref: '#/components/schemas/NotificationList'

    post:
      tags:
        - Notifications
      summary: Create notification (Internal)
      description: |
        Endpoint interno para que otros servicios envíen notificaciones.
        Soporta idempotencia mediante `idempotency_key`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationCreate'
            example:
              to: "user@mail.com"
              subject: "Nuevo post publicado"
              body: "Se ha publicado un nuevo post en el blog: 'Introducción a Microservicios'"
              notification_type: "email"
              source_service: "blog-service"
              idempotency_key: "blog-post-123-notification"
      responses:
        '201':
          description: Notificación creada y encolada
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: queued
                  message:
                    type: string
        '200':
          description: Notificación ya existe (idempotente)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                  status:
                    type: string
                  message:
                    type: string
                    example: Notification already exists (idempotent)

  /api/notify/stats/:
    get:
      tags:
        - Notifications
      summary: Notifications statistics
      description: Estadísticas de notificaciones por tipo y estado
      responses:
        '200':
          description: Estadísticas
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                  by_type:
                    type: object
                  by_status:
                    type: object

components:
  schemas:
    ContactMessageCreate:
      type: object
      required:
        - name
        - email
        - message
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
        email:
          type: string
          format: email
        message:
          type: string
          minLength: 10

    ContactMessage:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
        message:
          type: string
        status:
          type: string
          enum: [pending, queued, sent, failed]
        created_at:
          type: string
          format: date-time

    ContactMessageList:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time

    NotificationCreate:
      type: object
      required:
        - to
        - body
      properties:
        notification_type:
          type: string
          enum: [email, sms, push]
          default: email
        to:
          type: string
          format: email
        subject:
          type: string
          maxLength: 500
        body:
          type: string
        source_service:
          type: string
          maxLength: 100
        idempotency_key:
          type: string
          maxLength: 255
          description: Clave única para evitar duplicados

    NotificationList:
      type: object
      properties:
        id:
          type: string
          format: uuid
        notification_type:
          type: string
        to:
          type: string
        subject:
          type: string
        status:
          type: string
        source_service:
          type: string
        created_at:
          type: string
          format: date-time

    ValidationError:
      type: object
      properties:
        field_name:
          type: array
          items:
            type: string
